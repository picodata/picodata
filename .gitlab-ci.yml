default:
  tags:
    - docker-picodata
  interruptible: true

stages:
  - docker

workflow:
  # See https://docs.gitlab.com/ee/ci/jobs/job_control.html#avoid-duplicate-pipelines
  rules:
    # To avoid duplicate pipelines we disable merge request events,
    # leaving only pushes and manual triggering.
    - if: $CI_COMMIT_BRANCH == "DEVOPS-1221"
      when: always



variables:
  REGISTRY: docker-public.binary.picodata.io
  PARENT_BRANCH: "DEVOPS-1221"
  RUST_VERSION: 1.85
  DEFAULT_DESTINATION_TAG: ${CI_COMMIT_REF_SLUG}

.deploy-docker-tmpl:
  stage: docker
  variables:
    GIT_STRATEGY: none
    PUSH_DOCKER: ""
    MULTIARCH: "true"
  rules:
    - if: $CI_COMMIT_BRANCH == "DEVOPS-1221"

deploy-docker:
  extends: .deploy-docker-tmpl
  parallel:
    matrix:
      - DOCKERFILE: docker/picodata.Dockerfile
        DESTINATION: ${REGISTRY}/picodata:$DEFAULT_DESTINATION_TAG
      - DOCKERFILE: docker/picodata-distroless.Dockerfile
        DESTINATION: ${REGISTRY}/picodata:$DEFAULT_DESTINATION_TAG-distroless
  trigger:
    project: picodata/devops/picodata-in-docker
    branch: DEVOPS-1221
    strategy: depend
  variables:
    PARENT_BRANCH: $PARENT_BRANCH
    PARENT_PROJECT_PATH: $PARENT_PROJECT_PATH
